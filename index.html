<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Lottie ‚Äî Loader + Screen Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles/main.css" />
  <!-- Lottie –≥–ª–æ–±–∞–ª—å–Ω–æ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
</head>
<body>
  <nav class="tabs" role="tablist">
    <button class="tab-btn" id="tab-f1" aria-selected="true">Lottie Loader</button>
    <button class="tab-btn" id="tab-f2" aria-selected="false">Screen Preview (fullscreen)</button>
  </nav>

  <!-- Panel 1 -->
  <section id="panel-f1" class="panel active" role="tabpanel" aria-labelledby="tab-f1">
    <div class="controls">
      <label class="btn" for="f1-file">–í—ã–±—Ä–∞—Ç—å JSON</label>
      <input id="f1-file" type="file" accept=".json,application/json" />

      <select id="f1-sizeSelect">
        <option value="120">120√ó120</option>
        <option value="160">160√ó160</option>
        <option value="180">180√ó180</option>
        <option value="200">200√ó200</option>
        <option value="220" selected>220√ó220</option>
      </select>

      <div class="row">
        <input type="color" id="f1-colorPicker" value="#0f141c" />
        <input type="text" id="f1-colorInput" value="#0f141c" maxlength="7" placeholder="#rrggbb" />
      </div>

      <label class="switch"><span>Loop</span><input type="checkbox" id="f1-loopToggle" checked /></label>

      <button class="btn" id="f1-startBtn" disabled>Start</button>
      <button class="btn" id="f1-stopBtn" disabled>Stop</button>
    </div>

    <div id="f1-stage" title="–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å Lottie" tabindex="0">
      <span id="f1-stage-hint" class="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ —Å—é–¥–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Å–≤–µ—Ä—Ö—É</span>
    </div>
    <p class="hint" id="f1-status">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
  </section>

  <!-- Panel 2 -->
  <section id="panel-f2" class="panel" role="tabpanel" aria-labelledby="tab-f2">
    <div class="controls">
      <label class="btn" for="f2-imgFile">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω</label>
      <input id="f2-imgFile" type="file" accept="image/png,image/jpeg,image/webp" />
      <label class="btn" for="f2-jsonFile">–ó–∞–≥—Ä—É–∑–∏—Ç—å Lottie JSON</label>
      <input id="f2-jsonFile" type="file" accept=".json,application/json" />

      <button class="btn" id="f2-startBtn" disabled>Start</button>
      <button class="btn" id="f2-stopBtn" disabled>Stop</button>
      <label class="switch"><span>Loop</span><input type="checkbox" id="f2-loopToggle" checked /></label>
      <span class="hint">–ù–µ–ø—Ä–æ–∑—Ä.:</span>
      <input id="f2-opacityRange" type="range" min="0" max="100" value="100" />
    </div>

    <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ 32px -->
    <div class="viewport-wrap">
      <!-- –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è —Ä–∞–º–∫–∞ -->
      <div class="stage-frame" id="f2-stage" tabindex="0" aria-label="Screen Preview area">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–≤–µ–Ω —Ä–∞–∑–º–µ—Ä—É –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div class="stage-content" id="f2-content">
          <img id="f2-bgImg" alt="–°–∫—Ä–∏–Ω" />
          <div id="f2-animHost">
            <div class="handle nw"></div>
            <div class="handle ne"></div>
            <div class="handle sw"></div>
            <div class="handle se"></div>
          </div>
        </div>
      </div>
    </div>

    <p class="hint" id="f2-status">
      –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ 32px. –í—Å—Ç–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω (Ctrl/Cmd+V, Copy as PNG –≤ Figma)
      –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª ‚Äî –æ–Ω –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ –ª–æ–≥–∏—á–µ—Å–∫–æ–º —Ä–∞–∑–º–µ—Ä–µ.
    </p>
  </section>

  <!-- –°–∫—Ä–∏–ø—Ç—ã (–æ–±—ã—á–Ω—ã–µ —Ç–µ–≥–∏, –±–µ–∑ –º–æ–¥—É–ª–µ–π) -->
  <script src="./scripts/helpers.js"></script>
  <script src="./scripts/tabs.js"></script>
  <script src="./scripts/loader.js"></script>
  <script src="./scripts/preview.js"></script>
  <script src="./scripts/main.js"></script>

  <!-- –í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞ + —É–º–Ω—ã–π –º–∞—Å—à—Ç–∞–± (–º–æ–±–∏–ª–∫–∏/–¥–µ—Å–∫—Ç–æ–ø—ã) -->
  <script>
    (function enablePasteAndSizing(){
      const stage   = document.getElementById('f2-stage');    // –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å
      const content = document.getElementById('f2-content');  // —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ)
      const bg      = document.getElementById('f2-bgImg');    // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const status  = document.getElementById('f2-status');
      const imgFile = document.getElementById('f2-imgFile');

      if (!stage || !content || !bg) return;

      function setHint(msg){ if (status) status.textContent = msg; }

      function nearest(val, arr){
        return arr.reduce((best,cur)=>Math.abs(cur-val)<Math.abs(best-val)?cur:best, arr[0]);
      }
      const NEAR = (a,b,tol)=>Math.abs(a-b)<=tol;

      // –£–º–Ω—ã–π –∞–≤—Ç–æ—Å–∫–µ–π–ª –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö/–¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –º–∞–∫–µ—Ç–æ–≤
      function applyNaturalSize() {
        const W = bg.naturalWidth;
        const H = bg.naturalHeight;
        const AR = H / Math.max(W, 1); // –∞—Å–ø–µ–∫—Ç

        // –ú–æ–±–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —à–∏—Ä–∏–Ω—ã
        const MOBILE_WIDTHS  = [320, 360, 375, 390, 393, 412, 414, 428];
        // –¢–∏–ø–æ–≤—ã–µ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –º–∞–∫–µ—Ç–æ–≤
        const DESKTOP_WIDTHS = [1024, 1200, 1280, 1366, 1400, 1440, 1536, 1600, 1680, 1728, 1792, 1920, 2048];

        let targetW = W; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

        // 1) –î–µ—Å–∫—Ç–æ–ø 1√ó ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å –∫ –±–ª–∏–∂–∞–π—à–µ–π ¬´–∫—Ä–∞—Å–∏–≤–æ–π¬ª —à–∏—Ä–∏–Ω–µ
        const nearDesktop1x = DESKTOP_WIDTHS.find(dw => NEAR(W, dw, 60));
        if (nearDesktop1x) {
          targetW = nearest(W, DESKTOP_WIDTHS);
        } else {
          // 2) –î–µ—Å–∫—Ç–æ–ø 2√ó ‚Äî –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —à–∏—Ä–∏–Ω–µ (dw)
          const nearDesktop2x = DESKTOP_WIDTHS.find(dw => NEAR(W, dw * 2, 120));
          if (nearDesktop2x) {
            targetW = nearDesktop2x;
          } else {
            // 3) –ú–æ–±–∏–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—Ä–µ—Ç—ã (—Ä–µ—Ç–∏–Ω–∞ 2√ó/3√ó)
            const looksMobile = AR > 1.5; // –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–∑–Ω–∞–∫ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–∞
            if (looksMobile && W >= 700 && W <= 2500) {
              // —á–∞—â–µ –≤—Å–µ–≥–æ 2√ó –æ—Ç –ª–æ–≥–∏—á–µ—Å–∫–æ–π
              const approxLogical = W / 2;
              targetW = nearest(approxLogical, MOBILE_WIDTHS);
            } else if (looksMobile && (W >= 1100 && W <= 3800)) {
              // –≤–æ–∑–º–æ–∂–Ω—ã–π 3√ó —ç–∫—Å–ø–æ—Ä—Ç
              const approxLogical3x = W / 3;
              targetW = nearest(approxLogical3x, MOBILE_WIDTHS);
            }
          }
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±
        const scale = targetW / W;
        const w = Math.max(1, Math.round(W * scale));
        const h = Math.max(1, Math.round(H * scale));

        // –ö–æ–Ω—Ç–µ–Ω—Ç ‚Äî –≤ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
        content.style.width  = w + 'px';
        content.style.height = h + 'px';

        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
        bg.style.width  = '100%';
        bg.style.height = '100%';
        bg.style.display = 'block';

        console.log(`üìê natural ${W}√ó${H} ‚Üí logical ${w}√ó${h} (scale=${(+scale.toFixed(3))})`);
      }
      bg.addEventListener('load', applyNaturalSize);

      // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
      if (imgFile) {
        imgFile.addEventListener('change', (e) => {
          const f = e.target.files?.[0]; if (!f) return;
          bg.src = URL.createObjectURL(f);
          setHint('–°–∫—Ä–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω: ' + (f.name || '—Ñ–∞–π–ª'));
        });
      }

      // –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞
      stage.addEventListener('click', () => stage.focus());
      stage.addEventListener('paste', handlePaste);
      document.addEventListener('paste', handlePaste);

      function setImage(src, fileName) {
        bg.src = src; // onload –≤—ã–∑–æ–≤–µ—Ç applyNaturalSize()
        setHint('–°–∫—Ä–∏–Ω –≤—Å—Ç–∞–≤–ª–µ–Ω' + (fileName ? ': ' + fileName : ''));
      }

      async function handlePaste(e){
        try {
          const cd = e.clipboardData;
          if (!cd) return;

          // 1) –§–∞–π–ª-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          const item = [...cd.items].find(i => i.type && i.type.startsWith('image/'));
          if (item) {
            const file = item.getAsFile();
            if (file) {
              const url = URL.createObjectURL(file);
              setImage(url, file.name);
              e.preventDefault();
              return;
            }
          }

          // 2) Data URL
          const txt = cd.getData('text/plain');
          if (txt && txt.startsWith('data:image/')) {
            setImage(txt);
            e.preventDefault();
            return;
          }

          // 3) HTML <img>
          const html = cd.getData('text/html');
          if (html) {
            const wrap = document.createElement('div');
            wrap.innerHTML = html;
            const img = wrap.querySelector('img');
            if (img && img.src) {
              setImage(img.src);
              e.preventDefault();
              return;
            }
          }

          setHint('–í –±—É—Ñ–µ—Ä–µ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏. –í Figma: Copy as PNG ‚Üí Ctrl/Cmd+V –∑–¥–µ—Å—å.');
        } catch (err) {
          console.error('Paste error:', err);
          setHint('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
        }
      }
    })();
  </script>
</body>
</html>
