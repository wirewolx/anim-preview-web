<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Lottie Loader + Background</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- единственная зависимость -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color-scheme: dark; }
    body { margin: 0; background:#0b0f14; color:#e8eef5; }
    .header { padding:12px 16px; border-bottom:1px solid #223044; background:#0e1420; }
    .title { font-weight:600; }
    .panel { padding:20px; }
    .controls { margin-bottom:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    input[type="file"] { display:none; }
    .btn, select, input[type="text"], input[type="color"], input[type="range"], label.switch {
      border:1px solid #2a3b55; background:#172335; color:#e8eef5; border-radius:8px; padding:8px 10px; font-size:14px;
    }
    .btn { cursor:pointer; }
    .hint { font-size:13px; color:#9fb0c7; text-align:center; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .switch { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; background:#101725; border:1px solid #2a3b55; border-radius:8px; }
    .switch input { appearance:none; width:40px; height:22px; background:#213048; border-radius:999px; position:relative; outline:none; cursor:pointer; }
    .switch input:checked { background:#3a6cf0; }
    .switch input::after { content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:#e8eef5; transition:left .2s; }
    .switch input:checked::after { left:21px; }

    #f1-stage {
      position: relative; /* для слоя фона */
      padding:64px; display:flex; align-items:center; justify-content:center;
      background:#0f141c; border:1px dashed #2a3b55; border-radius:12px; overflow:hidden;
      transition: width .2s, height .2s, background .2s;
      margin:0 auto; cursor:pointer;
      width: 220px; height: 220px; /* дефолт под select */
    }
    #f1-stage:hover { border-color:#3a6cf0; }

    /* фон под анимацией */
    #bgImg {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: contain; /* можно переключать на cover */
      opacity: 1;
      pointer-events: none; /* клики проходят к stage */
      user-select: none;
    }

    /* Lottie-слой всегда выше фона */
    #lottieLayer, #f1-stage svg { position:relative; z-index:1; }
  </style>
</head>
<body>
  <header class="header">
    <div class="title">Lottie Loader</div>
  </header>

  <section id="panel-f1" class="panel">
    <div class="controls">
      <label class="btn" for="f1-file">Выбрать JSON</label>
      <input id="f1-file" type="file" accept=".json,application/json" />

      <select id="f1-sizeSelect" aria-label="Размер">
        <option value="120">120×120</option>
        <option value="160">160×160</option>
        <option value="180">180×180</option>
        <option value="200">200×200</option>
        <option value="220" selected>220×220</option>
      </select>

      <div class="row" role="group" aria-label="Цвет фона">
        <input type="color" id="f1-colorPicker" value="#0f141c" />
        <input type="text" id="f1-colorInput" value="#0f141c" maxlength="7" placeholder="#rrggbb" />
      </div>

      <label class="switch"><span>Loop</span><input type="checkbox" id="f1-loopToggle" checked /></label>

      <button class="btn" id="f1-startBtn" disabled>Start</button>
      <button class="btn" id="f1-stopBtn" disabled>Stop</button>
    </div>

    <!-- блок управления фоном -->
    <div class="controls">
      <label class="btn" for="f1-bgFile">Загрузить фон</label>
      <input id="f1-bgFile" type="file" accept="image/png,image/jpeg,image/webp" />
      <select id="bgFitSelect" title="Вписывание">
        <option value="contain" selected>Вписать (contain)</option>
        <option value="cover">Покрыть (cover)</option>
      </select>
      <label class="row" style="gap:6px;">
        <span class="hint">Прозрачность фона</span>
        <input id="bgOpacity" type="range" min="0" max="100" value="100" />
      </label>
      <button class="btn" id="bgClearBtn">Очистить фон</button>
    </div>

    <div id="f1-stage" title="Кликните, чтобы загрузить Lottie" tabindex="0">
      <img id="bgImg" alt="" />
      <!-- Lottie будет вставлять SVG прямо сюда -->
      <span id="f1-stage-hint" class="hint" style="z-index:1;">Кликните сюда или выберите JSON сверху</span>
    </div>

    <p class="hint" id="f1-status">Файл не загружен</p>
  </section>

  <!-- Встроенная логика -->
  <script>
    (function(){
      /*** DOM ***/
      const fileInput   = document.getElementById('f1-file');
      const sizeSelect  = document.getElementById('f1-sizeSelect');
      const colorPick   = document.getElementById('f1-colorPicker');
      const colorInput  = document.getElementById('f1-colorInput');
      const loopToggle  = document.getElementById('f1-loopToggle');
      const startBtn    = document.getElementById('f1-startBtn');
      const stopBtn     = document.getElementById('f1-stopBtn');
      const stage       = document.getElementById('f1-stage');
      const stageHint   = document.getElementById('f1-stage-hint');
      const statusEl    = document.getElementById('f1-status');

      // фон
      const bgFileInput = document.getElementById('f1-bgFile');
      const bgImg       = document.getElementById('bgImg');
      const bgFitSelect = document.getElementById('bgFitSelect');
      const bgOpacity   = document.getElementById('bgOpacity');
      const bgClearBtn  = document.getElementById('bgClearBtn');

      /*** state ***/
      let anim = null;
      let jsonData = null;

      /*** helpers ***/
      function setStatus(msg){ statusEl.textContent = msg; }
      function enableControls(loaded){
        startBtn.disabled = !loaded;
        stopBtn.disabled  = !loaded;
      }
      function setStageSize(px){
        stage.style.width  = px + 'px';
        stage.style.height = px + 'px';
      }
      function setBgColor(color){
        stage.style.background = color;
        colorPick.value = color;
        colorInput.value = color;
      }
      function validHex(v){ return /^#([0-9a-f]{6})$/i.test(v); }

      /*** UI bindings ***/
      sizeSelect.addEventListener('change', () => setStageSize(parseInt(sizeSelect.value,10)));

      colorPick.addEventListener('input', () => setBgColor(colorPick.value));
      colorInput.addEventListener('input', () => {
        const v = colorInput.value.trim();
        if (validHex(v)) setBgColor(v);
      });

      loopToggle.addEventListener('change', () => { if (anim) anim.loop = loopToggle.checked; });

      // загрузка JSON
      stage.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try {
          const txt = await f.text();
          jsonData = JSON.parse(txt);
          loadAnimation();
          setStatus('Загружен: ' + (f.name || 'Lottie JSON'));
        } catch(err){
          console.error(err);
          setStatus('Ошибка чтения JSON');
        }
      });

      startBtn.addEventListener('click', () => { if (anim) anim.play(); });
      stopBtn .addEventListener('click', () => { if (anim) anim.stop(); });

      // управление фоном
      bgFileInput.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        bgImg.src = url;
        bgImg.style.display = 'block';
        setStatus('Фон: ' + (f.name || 'изображение'));
      });

      bgFitSelect.addEventListener('change', () => {
        bgImg.style.objectFit = bgFitSelect.value; // contain / cover
      });

      bgOpacity.addEventListener('input', () => {
        const val = +bgOpacity.value; // 0..100
        bgImg.style.opacity = (val/100).toString();
      });

      bgClearBtn.addEventListener('click', () => {
        bgImg.removeAttribute('src');
        bgImg.style.display = 'none';
        setStatus('Фон очищен');
      });

      /*** core ***/
      function destroyAnim(){
        if (anim) { anim.destroy(); anim = null; }
        if (stageHint) stageHint.style.display = 'none';
      }

      function loadAnimation(){
        if (!jsonData) return;
        destroyAnim();

        anim = lottie.loadAnimation({
          container: stage,
          renderer: 'svg',
          loop: loopToggle.checked,
          autoplay: true,
          animationData: jsonData,
          rendererSettings: {
            preserveAspectRatio: 'xMidYMid meet',
            progressiveLoad: true,
          }
        });

        // убедимся, что SVG над фоном
        anim.addEventListener('DOMLoaded', () => {
          const svg = stage.querySelector('svg');
          if (svg) svg.style.zIndex = 1;
          enableControls(true);
          stage.setAttribute('title', 'Анимация загружена');
        });

        anim.addEventListener('data_failed', () => {
          setStatus('Ошибка: не удалось загрузить анимацию');
          enableControls(false);
        });
      }

      /*** init ***/
      setStageSize(parseInt(sizeSelect.value,10));
      setBgColor(colorPick.value);
      bgImg.style.display = 'none';
      bgImg.style.objectFit = bgFitSelect.value; // стартовое значение
      enableControls(false);
    })();
  </script>
</body>
</html>
