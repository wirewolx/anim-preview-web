<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Lottie — Loader + Screen Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles/main.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color-scheme: dark; }
    body { margin: 0; background:#0b0f14; color:#e8eef5; }

    /* Tabs */
    .tabs { display:flex; gap:8px; padding:12px 16px; border-bottom:1px solid #223044; background:#0e1420; position:sticky; top:0; z-index:20; }
    .tab-btn { padding:10px 14px; border-radius:8px; border:1px solid #2a3b55; background:#172335; color:#e8eef5; cursor:pointer; }
    .tab-btn[aria-selected="true"] { background:#1f2c43; border-color:#3b5175; }
    .panel { display:none; padding:20px; }
    .panel.active { display:block; }

    .controls { margin-bottom:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    input[type="file"] { display:none; }
    .btn, select, input[type="text"], input[type="color"], input[type="range"], label.switch {
      border:1px solid #2a3b55; background:#172335; color:#e8eef5; border-radius:8px; padding:8px 10px; font-size:14px;
    }
    .btn { cursor:pointer; }
    .hint { font-size:13px; color:#9fb0c7; text-align:center; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .switch { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; background:#101725; border:1px solid #2a3b55; border-radius:8px; }
    .switch input { appearance:none; width:40px; height:22px; background:#213048; border-radius:999px; position:relative; outline:none; cursor:pointer; }
    .switch input:checked { background:#3a6cf0; }
    .switch input::after { content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:#e8eef5; transition:left .2s; }
    .switch input:checked::after { left:21px; }

    /* Loader stage */
    #f1-stage {
      padding:64px; display:flex; align-items:center; justify-content:center;
      background:#0f141c; border:1px dashed #2a3b55; border-radius:12px;
      box-sizing:content-box; margin:0 auto; cursor:pointer;
    }
    #f1-stage:hover { border-color:#3a6cf0; }

    /* ===== Screen Preview ===== */
    .viewport-wrap { height: calc(100vh - 40px); box-sizing: border-box; }
    .stage-frame {
      height: 100%; width: 100%; margin: 0 auto;
      background: #0f141c; border: 1px solid #223044; border-radius: 12px;
      padding: 32px; box-sizing: border-box;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; /* без скролла */
    }
    .stage-content { position: relative; width: 0; height: 0; }
    #f2-bgImg {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      display: none;
      user-select: none; pointer-events: none;
    }

    /* Lottie host — фикс перетаскивания */
    #f2-animHost {
      position: absolute; left: 20px; top: 20px; width: 220px; height: 220px;
      outline: 1.5px dashed rgba(255,255,255,.35);
      border-radius: 2px; z-index: 2;
      cursor: grab;
      user-select: none;
      -webkit-user-drag: none;
      touch-action: none; /* важно для pointerevents на таче */
    }
    #f2-animHost.dragging { cursor: grabbing; }
  </style>
</head>
<body>
  <nav class="tabs" role="tablist">
    <button class="tab-btn" id="tab-f1" aria-selected="true">Lottie Loader</button>
    <button class="tab-btn" id="tab-f2" aria-selected="false">Screen Preview (32px padding)</button>
  </nav>

  <!-- Panel 1 -->
  <section id="panel-f1" class="panel active" role="tabpanel" aria-labelledby="tab-f1">
    <div class="controls">
      <label class="btn" for="f1-file">Выбрать JSON</label>
      <input id="f1-file" type="file" accept=".json,application/json" />
      <select id="f1-sizeSelect">
        <option value="120">120×120</option>
        <option value="160">160×160</option>
        <option value="180">180×180</option>
        <option value="200">200×200</option>
        <option value="220" selected>220×220</option>
      </select>
      <div class="row">
        <input type="color" id="f1-colorPicker" value="#0f141c" />
        <input type="text" id="f1-colorInput" value="#0f141c" maxlength="7" placeholder="#rrggbb" />
      </div>
      <label class="switch"><span>Loop</span><input type="checkbox" id="f1-loopToggle" checked /></label>
      <button class="btn" id="f1-startBtn" disabled>Start</button>
      <button class="btn" id="f1-stopBtn" disabled>Stop</button>
    </div>
    <div id="f1-stage" title="Кликните, чтобы загрузить Lottie" tabindex="0">
      <span id="f1-stage-hint" class="hint">Кликните сюда или выберите JSON сверху</span>
    </div>
    <p class="hint" id="f1-status">Файл не загружен</p>
  </section>

  <!-- Panel 2 -->
  <section id="panel-f2" class="panel" role="tabpanel" aria-labelledby="tab-f2">
    <div class="controls">
      <label class="btn" for="f2-imgFile">Загрузить скрин</label>
      <input id="f2-imgFile" type="file" accept="image/png,image/jpeg,image/webp" />
      <label class="btn" for="f2-jsonFile">Загрузить Lottie JSON</label>
      <input id="f2-jsonFile" type="file" accept=".json,application/json" />
    </div>

    <div class="viewport-wrap">
      <div class="stage-frame" id="f2-stage">
        <div class="stage-content" id="f2-content">
          <img id="f2-bgImg" alt="Скрин" />
          <div id="f2-animHost"></div>
        </div>
      </div>
    </div>

    <p class="hint" id="f2-status">
      Вставьте скрин (Ctrl/Cmd+V) или загрузите файл — он центрируется с 32px отступами, без скролла.
      Lottie-блок можно перетаскивать мышкой/тачем.
    </p>
  </section>

  <script>
    (function enablePasteAndFit(){
      const stage     = document.getElementById('f2-stage');
      const content   = document.getElementById('f2-content');
      const bg        = document.getElementById('f2-bgImg');
      const status    = document.getElementById('f2-status');
      const imgFile   = document.getElementById('f2-imgFile');
      const animHost  = document.getElementById('f2-animHost');

      if (!stage || !content || !bg || !animHost) return;
      function setHint(msg){ if (status) status.textContent = msg; }

      /* Fit image into area (center, 32px paddings, no scroll) */
      function fitAndCenter() {
        const W = bg.naturalWidth  || 1;
        const H = bg.naturalHeight || 1;
        const availW = stage.clientWidth  - 64; // 32+32
        const availH = stage.clientHeight - 64; // 32+32
        const scale = Math.min(availW / W, availH / H, 1);
        const w = Math.floor(W * scale);
        const h = Math.floor(H * scale);
        content.style.width  = w + 'px';
        content.style.height = h + 'px';
        bg.style.display = 'block';
      }

      window.addEventListener('resize', () => { if (bg.src) fitAndCenter(); });
      bg.addEventListener('load', fitAndCenter);

      if (imgFile) {
        imgFile.addEventListener('change', (e) => {
          const f = e.target.files?.[0]; if (!f) return;
          bg.src = URL.createObjectURL(f);
          setHint('Скрин загружен: ' + (f.name || 'файл'));
        });
      }

      stage.addEventListener('click', () => stage.focus());
      stage.addEventListener('paste', handlePaste);
      document.addEventListener('paste', handlePaste);

      function setImage(src, fileName) {
        bg.src = src;
        setHint('Скрин вставлен' + (fileName ? ': ' + fileName : ''));
      }

      async function handlePaste(e){
        try {
          const cd = e.clipboardData;
          if (!cd) return;
          const item = [...cd.items].find(i => i.type && i.type.startsWith('image/'));
          if (item) {
            const file = item.getAsFile();
            if (file) {
              const url = URL.createObjectURL(file);
              setImage(url, file.name);
              e.preventDefault(); return;
            }
          }
          const txt = cd.getData('text/plain');
          if (txt && txt.startsWith('data:image/')) { setImage(txt); e.preventDefault(); return; }
          const html = cd.getData('text/html');
          if (html) {
            const wrap = document.createElement('div');
            wrap.innerHTML = html;
            const img = wrap.querySelector('img');
            if (img && img.src) { setImage(img.src); e.preventDefault(); return; }
          }
          setHint('В буфере нет картинки. Copy as PNG → Ctrl/Cmd+V.');
        } catch (err) { console.error('Paste error:', err); setHint('Не удалось вставить изображение.'); }
      }

      /* ---- Smooth drag for Lottie host (no jumps) ---- */
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      let dragging = false, grabX = 0, grabY = 0, hostW = 0, hostH = 0;

      animHost.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        animHost.setPointerCapture(e.pointerId);
        dragging = true;
        animHost.classList.add('dragging');

        const hostRect   = animHost.getBoundingClientRect();
        const parentRect = content.getBoundingClientRect();

        hostW = hostRect.width;
        hostH = hostRect.height;

        // позиция курсора внутри системы координат content
        const cursorX_inContent = e.clientX - parentRect.left;
        const cursorY_inContent = e.clientY - parentRect.top;

        // смещение точки захвата относительно левого-верхнего угла animHost
        grabX = cursorX_inContent - (hostRect.left - parentRect.left);
        grabY = cursorY_inContent - (hostRect.top  - parentRect.top);
      });

      animHost.addEventListener('pointermove', (e) => {
        if (!dragging) return;

        const parentRect = content.getBoundingClientRect();
        const cursorX_inContent = e.clientX - parentRect.left;
        const cursorY_inContent = e.clientY - parentRect.top;

        // новое положение: курсор минус точка захвата
        let newLeft = cursorX_inContent - grabX;
        let newTop  = cursorY_inContent - grabY;

        // ограничиваем внутри content
        const maxLeft = content.clientWidth  - hostW;
        const maxTop  = content.clientHeight - hostH;
        newLeft = clamp(newLeft, 0, Math.max(0, maxLeft));
        newTop  = clamp(newTop, 0, Math.max(0, maxTop));

        animHost.style.left = newLeft + 'px';
        animHost.style.top  = newTop  + 'px';
      });

      const endDrag = (e) => {
        if (!dragging) return;
        dragging = false;
        animHost.classList.remove('dragging');
        if (e?.pointerId != null) {
          try { animHost.releasePointerCapture(e.pointerId); } catch {}
        }
      };
      animHost.addEventListener('pointerup', endDrag);
      animHost.addEventListener('pointercancel', endDrag);
      document.addEventListener('pointerup', endDrag);
    })();
  </script>
</body>
</html>
